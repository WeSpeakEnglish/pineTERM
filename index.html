<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pineTERM</title>
    <style>
        /* â”€â”€ Theme variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            /* Night (default) */
            --bg-gradient:       linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --accent:            #00d4ff;
            --accent-dark:       #0099cc;
            --body-text:         #e0e0e0;
            --label-text:        #8892b0;
            --panel-bg:          rgba(255,255,255,0.05);
            --panel-border:      rgba(255,255,255,0.1);
            --panel-shadow:      0 8px 32px rgba(0,0,0,0.3);
            --input-bg:          #1e2a3a;
            --input-bg-hover:    #243347;
            --input-border:      #3a5068;
            --input-text:        #e0e0e0;
            --select-option-bg:  #1a2535;
            --btn-secondary-bg:  rgba(255,255,255,0.1);
            --btn-secondary-fg:  #e0e0e0;
            --btn-secondary-bdr: rgba(255,255,255,0.2);
            --terminal-bg:       rgba(0,0,0,0.3);
            --terminal-border:   rgba(255,255,255,0.1);
            --statusbar-bg:      rgba(0,0,0,0.8);
            --statusbar-border:  rgba(255,255,255,0.1);
            --timestamp-color:   #5a6a7a;
            --data-hex-color:    #a8a8a8;
            --data-ascii-color:  #90ee90;
            --scrollbar-track:   rgba(0,0,0,0.2);
            --scrollbar-thumb:   rgba(255,255,255,0.2);
            --scrollbar-hover:   rgba(255,255,255,0.35);
            --tab-inactive:      #8892b0;
        }

        body.day {
            --bg-gradient:       linear-gradient(135deg, #dde8f5 0%, #c8dcf0 100%);
            --accent:            #0077bb;
            --accent-dark:       #005a99;
            --body-text:         #1a2a3a;
            --label-text:        #4a5a72;
            --panel-bg:          rgba(255,255,255,0.75);
            --panel-border:      rgba(0,80,160,0.15);
            --panel-shadow:      0 8px 32px rgba(0,60,120,0.12);
            --input-bg:          #ffffff;
            --input-bg-hover:    #f0f6ff;
            --input-border:      #96b8d8;
            --input-text:        #1a2a3a;
            --select-option-bg:  #ffffff;
            --btn-secondary-bg:  rgba(0,80,160,0.08);
            --btn-secondary-fg:  #1a2a3a;
            --btn-secondary-bdr: rgba(0,80,160,0.25);
            --terminal-bg:       #f4f8ff;
            --terminal-border:   rgba(0,80,160,0.15);
            --statusbar-bg:      rgba(220,235,250,0.95);
            --statusbar-border:  rgba(0,80,160,0.15);
            --timestamp-color:   #7a8fa8;
            --data-hex-color:    #4a6888;
            --data-ascii-color:  #1a7a3a;
            --scrollbar-track:   rgba(0,0,0,0.05);
            --scrollbar-thumb:   rgba(0,80,160,0.25);
            --scrollbar-hover:   rgba(0,80,160,0.45);
            --tab-inactive:      #4a6888;
        }

        /* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                         'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 60px;
            color: var(--body-text);
            transition: background 0.4s ease, color 0.4s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* â”€â”€ Header row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header-row {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 10px;
            padding: 8px 16px;
            border-radius: 16px;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            backdrop-filter: blur(10px);
            box-shadow: var(--panel-shadow), 0 0 60px rgba(0,180,255,0.06);
            overflow: hidden;
        }

        .header-row::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 3px,
                rgba(0,212,255,0.012) 3px,
                rgba(0,212,255,0.012) 4px
            );
            pointer-events: none;
            border-radius: 16px;
        }

        h1 {
            color: var(--accent);
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(0,180,255,0.25);
            transition: color 0.4s ease;
        }

        /* â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .theme-toggle {
            position: absolute;
            right: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 20px;
            padding: 5px 10px 5px 10px;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s, border-color 0.3s;
        }

        .theme-toggle:hover { border-color: var(--accent); }

        .theme-toggle-icon { font-size: 16px; line-height: 1; }

        .theme-toggle-label { display: none; }

        /* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
            box-shadow: var(--panel-shadow);
            transition: background 0.4s ease, border-color 0.4s ease;
        }

        .panel-title {
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* â”€â”€ Layout helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .connection-row {
            display: flex; flex-wrap: wrap; gap: 15px;
            align-items: end; justify-content: center;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }

        .input-group label {
            font-size: 12px;
            color: var(--label-text);
            font-weight: 500;
        }

        /* â”€â”€ Inputs & selects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        select, input[type="text"], input[type="file"], input[type="number"] {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--input-text);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            min-width: 100px;
            transition: background 0.3s ease, border-color 0.3s ease,
                        box-shadow 0.3s ease;
        }

        select { cursor: pointer; }

        select option {
            background: var(--select-option-bg);
            color: var(--input-text);
        }

        select:hover, input[type="text"]:hover, input[type="number"]:hover {
            background: var(--input-bg-hover);
            border-color: var(--accent);
        }

        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0,180,255,0.15);
        }

        input[type="number"] {
            min-width: 80px; width: 100px; text-align: center;
        }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        button {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border: none;
            color: #fff;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,180,255,0.4);
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        button.secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-fg);
            border: 1px solid var(--btn-secondary-bdr);
        }

        button.secondary:hover:not(:disabled) {
            background: var(--input-bg-hover);
            box-shadow: 0 5px 20px rgba(0,180,255,0.15);
        }

        button.danger {
            background: linear-gradient(135deg, #ff4757 0%, #cc0033 100%);
            color: white;
        }

        button.danger:hover:not(:disabled) {
            box-shadow: 0 5px 20px rgba(255,71,87,0.4);
        }

        /* â”€â”€ Send section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .send-section { display: flex; flex-direction: column; gap: 15px; }

        .send-row { display: flex; gap: 10px; align-items: center; }
        .send-row input[type="text"] { flex: 1; }

        .line-ending { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }

        .radio-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .radio-group input[type="radio"] { accent-color: var(--accent); }
        .radio-group label { color: var(--label-text); font-size: 13px; cursor: pointer; }

        .json-section { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .json-section input[type="text"] { flex: 1; min-width: 150px; }

        /* â”€â”€ Terminal tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .terminal-tabs {
            display: flex; gap: 20px; margin-bottom: 10px;
            align-items: center; flex-wrap: wrap;
        }

        .tab-buttons { display: flex; gap: 5px; }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--tab-inactive);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn:hover  { color: var(--accent); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

        .timing-control {
            display: flex; align-items: center; gap: 8px;
            margin-left: auto; font-size: 13px; color: var(--label-text);
        }

        .timing-control input[type="checkbox"] {
            accent-color: var(--accent); width: 16px; height: 16px;
        }

        /* â”€â”€ Terminal body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .terminal-container {
            border: 1px solid var(--terminal-border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--terminal-bg);
            transition: background 0.4s, border-color 0.4s;
        }

        .terminal-header {
            background: var(--panel-bg);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--terminal-border);
        }

        .terminal-title { font-size: 13px; color: var(--accent); font-weight: 600; }

        .terminal-controls { display: flex; gap: 10px; align-items: center; }

        .checkbox-group { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .checkbox-group input[type="checkbox"] { accent-color: var(--accent); }
        .checkbox-group label { font-size: 12px; color: var(--label-text); cursor: pointer; }

        .terminal-body {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            display: none;
        }

        .terminal-body.active { display: block; }

        .log-entry { margin-bottom: 4px; display: flex; gap: 10px; }

        .timestamp { color: var(--timestamp-color); min-width: 85px; }

        .direction { font-weight: bold; min-width: 20px; }
        .direction.rx { color: var(--accent); }
        .direction.tx { color: #ff6b6b; }

        .data { color: var(--body-text); word-break: break-all; }
        .data.hex { color: var(--data-hex-color); }
        .ascii-view .data { color: var(--data-ascii-color); }

        /* â”€â”€ Status bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--statusbar-bg);
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid var(--statusbar-border);
            font-size: 12px; z-index: 100;
            transition: background 0.4s, border-color 0.4s;
        }

        .status-indicator { display: flex; align-items: center; gap: 8px; }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #ff4757; box-shadow: 0 0 10px #ff4757;
            transition: all 0.3s ease;
        }

        .status-dot.connected { background: #2ed573; box-shadow: 0 0 10px #2ed573; }

        .stats { display: flex; gap: 20px; color: var(--label-text); }
        .stat  { display: flex; gap: 5px; }
        .stat-value { color: var(--accent); font-weight: 600; }

        /* â”€â”€ Scrollbars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track  { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb  { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }

        /* â”€â”€ Day theme header adjustments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        body.day .header-row {
            box-shadow: var(--panel-shadow), 0 0 60px rgba(0,100,180,0.08);
        }
        body.day .header-row::before {
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 3px,
                rgba(0,100,180,0.018) 3px,
                rgba(0,100,180,0.018) 4px
            );
        }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .connection-row { flex-direction: column; align-items: stretch; }
            .input-group { width: 100%; }
            select, input[type="text"] { width: 100%; }
            .terminal-tabs { flex-direction: column; align-items: flex-start; }
            .timing-control { margin-left: 0; margin-top: 10px; }
            .theme-toggle { position: static; margin-left: auto; }
            .header-row { flex-wrap: wrap; gap: 10px; }
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 100" width="480" height="100" style="max-width:100%;height:auto;position:relative;z-index:1;">
              <defs>
                <filter id="tg" x="-10%" y="-40%" width="120%" height="180%">
                  <feGaussianBlur stdDeviation="5" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <!-- "pine" in app accent cyan -->
              <text x="22" y="66"
                font-family="'Courier New', Courier, monospace"
                font-size="62" font-weight="bold"
                fill="#00d4ff" filter="url(#tg)"
                letter-spacing="-1">pine</text>
              <!-- "TERM" slightly dimmer white-cyan -->
              <text x="168" y="66"
                font-family="'Courier New', Courier, monospace"
                font-size="62" font-weight="bold"
                fill="#e0f7ff"
                letter-spacing="-1">TERM</text>
              <!-- Blinking cursor in accent color -->
              <rect x="335" y="16" width="13" height="55" rx="2" fill="#00d4ff" opacity="0.9">
                <animate attributeName="opacity" values="0.9;0.08;0.9" dur="1.1s" repeatCount="indefinite"/>
              </rect>
              <!-- Tagline -->
              <text x="22" y="87"
                font-family="'Courier New', Courier, monospace"
                font-size="10" fill="#00d4ff" opacity="0.38" letter-spacing="2.2">WEB Â· UART Â· SERIAL TERMINAL</text>
              <!-- Bit-stream dots in accent -->
              <g opacity="0.22" transform="translate(302,88)">
                <rect x="0"   y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="7"   y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="14"  y="0" width="3" height="3" rx="0.8" fill="#0066aa"/>
                <rect x="21"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="28"  y="0" width="3" height="3" rx="0.8" fill="#0066aa"/>
                <rect x="35"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="42"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="49"  y="0" width="3" height="3" rx="0.8" fill="#0066aa"/>
                <rect x="56"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="63"  y="0" width="3" height="3" rx="0.8" fill="#0066aa"/>
                <rect x="70"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="77"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="84"  y="0" width="3" height="3" rx="0.8" fill="#0066aa"/>
                <rect x="91"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="98"  y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
                <rect x="105" y="0" width="3" height="3" rx="0.8" fill="#0066aa"/>
                <rect x="112" y="0" width="3" height="3" rx="0.8" fill="#00d4ff"/>
              </g>
            </svg>
            <button class="theme-toggle secondary" onclick="toggleTheme()" id="themeBtn">
                <span class="theme-toggle-icon" id="themeIcon">ğŸŒ™</span>
                <span class="theme-toggle-label" id="themeLabel">Night</span>
            </button>
        </div>

        <!-- Connection Panel -->
        <div class="panel">
            <div class="panel-title">Connection Settings</div>
            <div class="connection-row">
                <div class="input-group">
                    <label>Baud rate</label>
                    <select id="baudRate">
                        <option value="9600" selected>9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                        <option value="230400">230400</option>
                        <option value="460800">460800</option>
                        <option value="921600">921600</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Data bits</label>
                    <select id="dataBits">
                        <option value="7">7</option>
                        <option value="8" selected>8</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Stop bits</label>
                    <select id="stopBits">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Parity</label>
                    <select id="parity">
                        <option value="none" selected>None</option>
                        <option value="even">Even</option>
                        <option value="odd">Odd</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Flow Control</label>
                    <select id="flowControl">
                        <option value="none" selected>None</option>
                        <option value="hardware">Hardware</option>
                    </select>
                </div>
                <button id="connectBtn" onclick="toggleConnection()">Connect to UART</button>
            </div>
        </div>

        <!-- Send Command Panel -->
        <div class="panel">
            <div class="panel-title">Send Command</div>
            <div class="send-section">
                <div class="send-row">
                    <input type="text" id="hexInput" placeholder="50 51 52 (HEX bytes separated by space)" maxlength="200">
                    <button onclick="sendHex()">Send HEX</button>
                </div>
                <div class="send-row">
                    <input type="text" id="asciiInput" placeholder="PQR (ASCII text)">
                    <button onclick="sendAscii()">Send ASCII</button>
                </div>
                
                <div class="line-ending">
                    <span style="color: #8892b0; font-size: 13px;">At the end:</span>
                    <label class="radio-group">
                        <input type="radio" name="lineEnding" value="crlf" checked>
                        <span>Send CR LF</span>
                    </label>
                    <label class="radio-group">
                        <input type="radio" name="lineEnding" value="lf">
                        <span>Send LF</span>
                    </label>
                    <label class="radio-group">
                        <input type="radio" name="lineEnding" value="cr">
                        <span>Send CR</span>
                    </label>
                    <label class="radio-group">
                        <input type="radio" name="lineEnding" value="none">
                        <span>No ending</span>
                    </label>
                </div>

                <div class="json-section">
                    <span style="color: #8892b0; font-size: 13px;">Send JSON command sequence</span>
                    <input type="text" id="jsonFileName" placeholder="Cmd.json" readonly>
                    <button class="secondary" onclick="document.getElementById('jsonFile').click()">Select JSON</button>
                    <input type="file" id="jsonFile" accept=".json" style="display: none;" onchange="handleJsonSelect(this)">
                    <button id="sendJsonBtn" onclick="sendJsonCommands()">Send JSON Commands</button>
                    <button id="stopJsonBtn" class="danger" onclick="stopJsonCommands()" style="display:none;">Stop</button>
                </div>
            </div>
        </div>

        <!-- Combined Terminal Panel -->
        <div class="panel">
            <div class="terminal-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('hex')">HEX VIEW</button>
                    <button class="tab-btn" onclick="switchTab('ascii')">ASCII VIEW</button>
                </div>
                <div class="timing-control">
                    <input type="checkbox" id="enableTiming" checked>
                    <span>Separated less than</span>
                    <input type="number" id="timingValue" value="5000" min="0" max="1000000" step="1000">
                    <span>Î¼Sec treat like one package</span>
                </div>
                <div class="terminal-controls" style="margin-left: auto;">
                    <button class="secondary" onclick="exportLog()">Export log</button>
                    <label class="checkbox-group">
                        <input type="checkbox" id="autoScroll" checked>
                        <span>Auto scroll</span>
                    </label>
                    <button class="secondary danger" onclick="clearTerminal()">Clear</button>
                </div>
            </div>
            
            <div class="terminal-container">
                <div class="terminal-body active" id="hexTerminal"></div>
                <div class="terminal-body ascii-view" id="asciiTerminal"></div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
        <div class="stats">
            <div class="stat">
                <span>RX:</span>
                <span class="stat-value" id="rxCount">0 bytes</span>
            </div>
            <div class="stat">
                <span>TX:</span>
                <span class="stat-value" id="txCount">0 bytes</span>
            </div>
        </div>
    </div>

    <script>
        let port = null;
        let reader = null;
        let writer = null;
        let readLoop = null;
        let isConnected = false;
        let rxBytes = 0;
        let txBytes = 0;
        let jsonCommands = null;
        let jsonRunning  = false;  // true while a JSON sequence is executing
        
        // Timing/buffering variables
        let receiveBuffer = [];
        let lastReceiveTime = 0;
        let bufferTimeout = null;

        // Check browser support
        if (!('serial' in navigator)) {
            alert('Web Serial API is not supported in this browser. Please use Chrome, Edge, or Opera.');
        }

        // HEX Input handling - Auto-format and validate
        const hexInput = document.getElementById('hexInput');
        
        hexInput.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            const originalLength = this.value.length;
            
            // Remove all non-hex characters and spaces
            let value = this.value.replace(/[^0-9A-Fa-f\s]/g, '').toUpperCase();
            
            // Remove existing spaces
            value = value.replace(/\s/g, '');
            
            // Limit to valid hex pairs (max 100 bytes = 200 chars)
            if (value.length > 200) {
                value = value.substring(0, 200);
            }
            
            // Insert space every 2 characters
            let formatted = '';
            for (let i = 0; i < value.length; i += 2) {
                if (i > 0) formatted += ' ';
                formatted += value.substring(i, i + 2);
            }
            
            this.value = formatted;
            
            // Adjust cursor position
            const newLength = this.value.length;
            let newCursorPosition = cursorPosition;
            
            // If characters were added (space insertion), move cursor accordingly
            if (newLength > originalLength) {
                newCursorPosition = cursorPosition + 1;
            } else if (newLength < originalLength) {
                // Characters were removed
                newCursorPosition = cursorPosition - (originalLength - newLength);
            }
            
            // Ensure cursor doesn't go beyond input length
            newCursorPosition = Math.min(newCursorPosition, this.value.length);
            this.setSelectionRange(newCursorPosition, newCursorPosition);
        });

        // Prevent invalid characters on keypress
        hexInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            // Allow only hex digits (0-9, A-F, a-f) and control keys
            if (!/[0-9A-Fa-f]/.test(char) && e.which !== 8 && e.which !== 32 && e.which !== 13) {
                e.preventDefault();
            }
        });

        // Handle paste - clean up pasted content
        hexInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            
            // Clean pasted content - keep only hex digits
            const cleaned = pastedText.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
            
            // Format with spaces
            let formatted = '';
            for (let i = 0; i < cleaned.length && i < 200; i += 2) {
                if (i > 0) formatted += ' ';
                formatted += cleaned.substring(i, i + 2);
            }
            
            // Insert at cursor position
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const currentValue = this.value.replace(/\s/g, '');
            const beforeCursor = currentValue.substring(0, start);
            const afterCursor = currentValue.substring(end);
            const newValue = beforeCursor + cleaned + afterCursor;
            
            // Reformat
            let finalFormatted = '';
            for (let i = 0; i < newValue.length && i < 200; i += 2) {
                if (i > 0) finalFormatted += ' ';
                finalFormatted += newValue.substring(i, i + 2);
            }
            
            this.value = finalFormatted;
        });

        function getLineEnding() {
            const selected = document.querySelector('input[name="lineEnding"]:checked').value;
            switch(selected) {
                case 'crlf': return '\r\n';
                case 'lf': return '\n';
                case 'cr': return '\r';
                default: return '';
            }
        }

        function switchTab(tab) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update terminal bodies
            document.getElementById('hexTerminal').classList.toggle('active', tab === 'hex');
            document.getElementById('asciiTerminal').classList.toggle('active', tab === 'ascii');
        }

        async function toggleConnection() {
            const btn = document.getElementById('connectBtn');
            
            if (!isConnected) {
                try {
                    port = await navigator.serial.requestPort();
                    
                    const options = {
                        baudRate: parseInt(document.getElementById('baudRate').value),
                        dataBits: parseInt(document.getElementById('dataBits').value),
                        stopBits: parseInt(document.getElementById('stopBits').value),
                        parity: document.getElementById('parity').value,
                        flowControl: document.getElementById('flowControl').value
                    };

                    await port.open(options);
                    
                    writer = port.writable.getWriter();
                    reader = port.readable.getReader();
                    
                    isConnected = true;
                    btn.textContent = 'Disconnect';
                    btn.classList.add('danger');
                    updateStatus(true);
                    
                    readLoop = readData();
                    
                    // Disable settings while connected
                    document.querySelectorAll('.connection-row select').forEach(s => s.disabled = true);
                    
                } catch (err) {
                    console.error('Connection error:', err);
                    alert('Failed to connect: ' + err.message);
                }
            } else {
                await disconnect();
            }
        }

        async function disconnect() {
            isConnected = false;
            updateStatus(false);
            
            if (reader) {
                await reader.cancel();
                reader = null;
            }
            
            if (writer) {
                await writer.releaseLock();
                writer = null;
            }
            
            if (port) {
                await port.close();
                port = null;
            }
            
            document.getElementById('connectBtn').textContent = 'Connect to UART';
            document.getElementById('connectBtn').classList.remove('danger');
            
            // Re-enable settings
            document.querySelectorAll('.connection-row select').forEach(s => s.disabled = false);
        }

        async function readData() {
            try {
                while (isConnected) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    if (value && value.length > 0) {
                        const now = Date.now();
                        const timingEnabled = document.getElementById('enableTiming').checked;
                        const timingThreshold = parseInt(document.getElementById('timingValue').value) || 50000;
                        
                        if (timingEnabled) {
                            // Check if this is a new packet or continuation
                            const timeSinceLast = (now - lastReceiveTime) * 1000; // convert to microseconds
                            
                            if (timeSinceLast > timingThreshold && receiveBuffer.length > 0) {
                                // Flush previous buffer as a complete packet
                                flushReceiveBuffer();
                            }
                            
                            // Add to buffer
                            receiveBuffer.push(...value);
                            lastReceiveTime = now;
                            
                            // Set timeout to flush buffer
                            if (bufferTimeout) clearTimeout(bufferTimeout);
                            bufferTimeout = setTimeout(() => {
                                if (receiveBuffer.length > 0) {
                                    flushReceiveBuffer();
                                }
                            }, timingThreshold / 1000 + 10); // Convert Î¼s to ms, add small buffer
                        } else {
                            // No timing - log immediately
                            processReceivedData(value);
                        }
                    }
                }
            } catch (err) {
                if (isConnected) {
                    console.error('Read error:', err);
                    await disconnect();
                }
            }
        }

        function flushReceiveBuffer() {
            if (receiveBuffer.length === 0) return;
            
            const data = new Uint8Array(receiveBuffer);
            processReceivedData(data);
            receiveBuffer = [];
        }

        function processReceivedData(data) {
            rxBytes += data.length;
            updateStats();
            logData(data, 'rx');
        }

        function logData(data, direction) {
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3 
            });
            
            // HEX view
            const hexStr = Array.from(data)
                .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                .join(' ');
            
            const hexEntry = document.createElement('div');
            hexEntry.className = 'log-entry';
            hexEntry.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <span class="direction ${direction}">${direction.toUpperCase()}</span>
                <span class="data hex">${hexStr}</span>
            `;
            
            const hexTerminal = document.getElementById('hexTerminal');
            hexTerminal.appendChild(hexEntry);
            
            if (document.getElementById('autoScroll').checked) {
                hexTerminal.scrollTop = hexTerminal.scrollHeight;
            }
            
            // ASCII view
            const asciiStr = Array.from(data)
                .map(b => {
                    if (b >= 32 && b <= 126) return String.fromCharCode(b);
                    if (b === 10) return 'âŠ';
                    if (b === 13) return 'â';
                    if (b === 9) return 'â‰';
                    return 'Â·';
                })
                .join('');
            
            const asciiEntry = document.createElement('div');
            asciiEntry.className = 'log-entry';
            asciiEntry.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <span class="direction ${direction}">${direction.toUpperCase()}</span>
                <span class="data">${asciiStr}</span>
            `;
            
            const asciiTerminal = document.getElementById('asciiTerminal');
            asciiTerminal.appendChild(asciiEntry);
            
            if (document.getElementById('autoScroll').checked) {
                asciiTerminal.scrollTop = asciiTerminal.scrollHeight;
            }
        }

        async function sendHex() {
            if (!isConnected) {
                alert('Please connect to UART first');
                return;
            }
            
            const input = document.getElementById('hexInput').value.trim();
            if (!input) return;
            
            try {
                const bytes = input.split(/\s+/)
                    .map(b => parseInt(b, 16))
                    .filter(b => !isNaN(b) && b >= 0 && b <= 255);
                
                if (bytes.length === 0) {
                    alert('Invalid HEX input');
                    return;
                }
                
                const data = new Uint8Array(bytes);
                const ending = getLineEnding();
                if (ending) {
                    const endingBytes = new TextEncoder().encode(ending);
                    const combined = new Uint8Array(data.length + endingBytes.length);
                    combined.set(data);
                    combined.set(endingBytes, data.length);
                    await writer.write(combined);
                    txBytes += combined.length;
                    logData(combined, 'tx');
                } else {
                    await writer.write(data);
                    txBytes += data.length;
                    logData(data, 'tx');
                }
                
                updateStats();
                // Input stays after sending - NOT clearing
            } catch (err) {
                console.error('Send error:', err);
                alert('Failed to send: ' + err.message);
            }
        }

        async function sendAscii() {
            if (!isConnected) {
                alert('Please connect to UART first');
                return;
            }
            
            const input = document.getElementById('asciiInput').value;
            const ending = getLineEnding();
            const text = input + ending;
            
            try {
                const data = new TextEncoder().encode(text);
                await writer.write(data);
                txBytes += data.length;
                updateStats();
                logData(data, 'tx');
                // Input stays after sending - NOT clearing
            } catch (err) {
                console.error('Send error:', err);
                alert('Failed to send: ' + err.message);
            }
        }

        function handleJsonSelect(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('jsonFileName').value = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        jsonCommands = JSON.parse(e.target.result);
                        console.log('JSON commands loaded:', jsonCommands);
                    } catch (err) {
                        alert('Invalid JSON file');
                        jsonCommands = null;
                    }
                };
                reader.readAsText(file);
            }
        }

        async function sendJsonCommands() {
            if (!isConnected) {
                alert('Please connect to UART first');
                return;
            }
            
            if (!jsonCommands) {
                alert('Please select a valid JSON file first');
                return;
            }
            
            if (jsonRunning) return;
            jsonRunning = true;
            document.getElementById('sendJsonBtn').disabled = true;
            document.getElementById('stopJsonBtn').style.display = '';

            try {
                if (Array.isArray(jsonCommands)) {
                    for (const cmd of jsonCommands) {
                        if (!jsonRunning) break;

                        let data;
                        let preDelay  = 0;
                        let postDelay = 100; // default inter-command gap
                        let times     = 1;   // times: 0=skip, 1=once, N=N times, -1=infinite

                        if (typeof cmd === 'string') {
                            data = new TextEncoder().encode(cmd + getLineEnding());
                        } else if (cmd.type === 'hex') {
                            const bytes = cmd.data.split(/\s+/).map(b => parseInt(b, 16));
                            data = new Uint8Array(bytes);
                            if (typeof cmd.preDelay  === 'number') preDelay  = cmd.preDelay;
                            if (typeof cmd.postDelay === 'number') postDelay = cmd.postDelay;
                            if (typeof cmd.times     === 'number') times     = cmd.times;
                        } else {
                            data = new TextEncoder().encode(cmd.data + getLineEnding());
                            if (typeof cmd.preDelay  === 'number') preDelay  = cmd.preDelay;
                            if (typeof cmd.postDelay === 'number') postDelay = cmd.postDelay;
                            if (typeof cmd.times     === 'number') times     = cmd.times;
                        }

                        if (times === 0) continue; // skip this command

                        const infinite = (times === -1);
                        let i = 0;
                        while (jsonRunning && (infinite || i < times)) {
                            if (preDelay > 0) await new Promise(r => setTimeout(r, preDelay));
                            if (!jsonRunning) break;

                            await writer.write(data);
                            txBytes += data.length;
                            logData(data, 'tx');
                            updateStats();

                            if (postDelay > 0) await new Promise(r => setTimeout(r, postDelay));
                            if (!infinite) i++;
                        }
                    }
                } else {
                    alert('JSON must be an array of commands');
                }
            } catch (err) {
                console.error('JSON send error:', err);
                alert('Failed to send JSON commands: ' + err.message);
            } finally {
                jsonRunning = false;
                document.getElementById('sendJsonBtn').disabled = false;
                document.getElementById('stopJsonBtn').style.display = 'none';
            }
        }

        function stopJsonCommands() {
            jsonRunning = false;
        }

        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = `Connected (${document.getElementById('baudRate').value} baud)`;
                text.style.color = '#2ed573';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Disconnected';
                text.style.color = '#e0e0e0';
            }
        }

        function updateStats() {
            document.getElementById('rxCount').textContent = `${rxBytes} bytes`;
            document.getElementById('txCount').textContent = `${txBytes} bytes`;
        }

        function clearTerminal() {
            document.getElementById('hexTerminal').innerHTML = '';
            document.getElementById('asciiTerminal').innerHTML = '';
        }

        function exportLog() {
            const activeTab = document.getElementById('hexTerminal').classList.contains('active') ? 'hex' : 'ascii';
            const terminal = document.getElementById(activeTab + 'Terminal');
            const entries = terminal.querySelectorAll('.log-entry');
            let log = '';
            
            entries.forEach(entry => {
                const timestamp = entry.querySelector('.timestamp').textContent;
                const direction = entry.querySelector('.direction').textContent;
                const data = entry.querySelector('.data').textContent;
                log += `[${timestamp}] ${direction}: ${data}\n`;
            });
            
            const blob = new Blob([log], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `uart-log-${activeTab}-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Handle Enter key in inputs
        document.getElementById('hexInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendHex();
        });
        
        document.getElementById('asciiInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendAscii();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (isConnected) disconnect();
        });

        // â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let isDayTheme = false;

        function toggleTheme() {
            isDayTheme = !isDayTheme;
            document.body.classList.toggle('day', isDayTheme);
            document.getElementById('themeIcon').textContent  = isDayTheme ? 'â˜€ï¸' : 'ğŸŒ™';
            document.getElementById('themeLabel').textContent = isDayTheme ? 'Day' : 'Night';
            try { localStorage.setItem('pineTERM-theme', isDayTheme ? 'day' : 'night'); } catch(e) {}
        }

        // Restore saved theme on load
        try {
            if (localStorage.getItem('pineTERM-theme') === 'day') toggleTheme();
        } catch(e) {}
    </script>
</body>
</html>